<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Data Checker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 20px; 
            line-height: 1.4;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #ff4444; text-align: center; }
        .section { 
            background: #2a2a2a; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #444;
        }
        .table-name { color: #44aaff; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .count { color: #ffaa44; font-weight: bold; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .stat-card { background: #333; padding: 10px; border-radius: 4px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Rakovinobijec Analytics Data Checker</h1>
        <div id="status">üîÑ Connecting to database...</div>
        <div id="results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gonsippgsrbutwanzpyo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvbnNpcHBnc3JidXR3YW56cHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzAyNDEsImV4cCI6MjA3MDMwNjI0MX0.2FINt1ku94IMVYzp7zKJvFSt0Z7t6gj-lCsAwcwMCXs';

        let supabase;
        let results = [];

        async function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                document.getElementById('status').innerHTML = '<span class="success">‚úÖ Connected to Supabase</span>';
                return true;
            } catch (error) {
                document.getElementById('status').innerHTML = `<span class="error">‚ùå Connection failed: ${error.message}</span>`;
                return false;
            }
        }

        async function checkTable(tableName, sampleLimit = 3) {
            console.log(`üîç Checking table: ${tableName}`);
            
            try {
                // Simple select first - no count, no ordering
                const { data: simpleData, error: simpleError } = await supabase
                    .from(tableName)
                    .select('*')
                    .limit(sampleLimit);

                if (simpleError) {
                    console.error(`‚ùå Simple select failed for ${tableName}:`, simpleError);
                    return {
                        error: `${simpleError.message} (Code: ${simpleError.code})`,
                        errorDetails: simpleError,
                        count: 0,
                        sample: []
                    };
                }

                console.log(`‚úÖ Simple select OK for ${tableName}, got ${simpleData?.length || 0} rows`);

                // Try to get count separately
                let totalCount = simpleData?.length || 0;
                try {
                    const { count, error: countError } = await supabase
                        .from(tableName)
                        .select('*', { count: 'exact', head: true });
                    
                    if (!countError && count !== null) {
                        totalCount = count;
                        console.log(`üìä Count for ${tableName}: ${count}`);
                    }
                } catch (countErr) {
                    console.warn(`‚ö†Ô∏è Count query failed for ${tableName}:`, countErr);
                }

                return {
                    count: totalCount,
                    sample: simpleData || []
                };

            } catch (error) {
                console.error(`‚ùå Table check failed for ${tableName}:`, error);
                return {
                    error: `${error.message}`,
                    errorDetails: error,
                    count: 0,
                    sample: []
                };
            }
        }

        async function checkAllTables() {
            const tables = [
                'game_sessions',
                'high_scores', 
                'enemy_stats',
                'death_events',
                'powerup_events',
                'boss_encounters',
                'performance_metrics'
            ];

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>üìä Analytics Tables Status:</h2>';

            let totalRecords = 0;
            const stats = {};

            for (const table of tables) {
                const result = await checkTable(table);
                
                let html = `<div class="section">`;
                html += `<div class="table-name">üìã ${table}</div>`;
                
                if (result.error) {
                    html += `<div class="error">‚ùå Error: ${result.error}</div>`;
                    if (result.errorDetails) {
                        html += `<details><summary>üîç Error Details</summary>`;
                        html += `<pre>${JSON.stringify(result.errorDetails, null, 2)}</pre>`;
                        html += `</details>`;
                    }
                } else {
                    const count = result.count;
                    totalRecords += count;
                    stats[table] = count;
                    
                    html += `<div class="count">üìà Records: ${count}</div>`;
                    
                    if (count > 0 && result.sample.length > 0) {
                        html += `<div class="success">‚úÖ Table is active</div>`;
                        html += `<details><summary>üìÑ Sample data (${result.sample.length} records):</summary>`;
                        html += `<pre>${JSON.stringify(result.sample, null, 2)}</pre>`;
                        html += `</details>`;
                    } else {
                        html += `<div style="color: #888;">‚ö™ No data yet</div>`;
                    }
                }
                
                html += `</div>`;
                resultsDiv.innerHTML += html;
            }

            // Add summary
            let summaryHtml = `<div class="section">`;
            summaryHtml += `<div class="table-name">üìä Summary</div>`;
            summaryHtml += `<div class="count">Total Records: ${totalRecords}</div>`;
            summaryHtml += `<div class="stats">`;
            
            for (const [table, count] of Object.entries(stats)) {
                summaryHtml += `<div class="stat-card">`;
                summaryHtml += `<div>${table}</div>`;
                summaryHtml += `<div class="count">${count}</div>`;
                summaryHtml += `</div>`;
            }
            
            summaryHtml += `</div></div>`;
            
            resultsDiv.innerHTML = summaryHtml + resultsDiv.innerHTML;

            // Add recent sessions info
            if (stats.game_sessions > 0) {
                await checkRecentActivity();
            }
        }

        async function checkRecentActivity() {
            try {
                const { data: recentSessions, error } = await supabase
                    .from('game_sessions')
                    .select('session_id, player_name, final_score, final_level, created_at, duration')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                let html = `<div class="section">`;
                html += `<div class="table-name">üïê Recent Sessions</div>`;
                
                if (recentSessions && recentSessions.length > 0) {
                    html += `<div class="success">‚úÖ Found ${recentSessions.length} recent sessions</div>`;
                    html += `<pre>${JSON.stringify(recentSessions, null, 2)}</pre>`;
                } else {
                    html += `<div style="color: #888;">No recent sessions found</div>`;
                }
                
                html += `</div>`;
                document.getElementById('results').innerHTML += html;
                
            } catch (error) {
                console.error('Error checking recent activity:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const connected = await initSupabase();
            if (connected) {
                await checkAllTables();
            }
        });
    </script>
</body>
</html>