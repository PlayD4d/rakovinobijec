<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Analytics Test - Rakovinobijec</title>
    <style>
        body { font-family: monospace; background: #001122; color: #fff; padding: 20px; }
        .log { background: #222; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { border-left: 4px solid #0f0; }
        .error { border-left: 4px solid #f00; }
        .warning { border-left: 4px solid #ff0; }
        button { padding: 10px 20px; margin: 10px; background: #00f; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #44f; }
    </style>
</head>
<body>
    <h1>üß™ Analytics System Test</h1>
    <p>Testov√°n√≠ sbƒõru hern√≠ch dat p≈ôed implementac√≠ do hlavn√≠ hry.</p>
    
    <div id="status">Naƒç√≠t√°n√≠...</div>
    
    <div>
        <button onclick="testSupabaseConnection()">Test Supabase Connection</button>
        <button onclick="testAnalyticsManager()">Test AnalyticsManager</button>
        <button onclick="testMockSession()">Simulate Game Session</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="logs"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        import { AnalyticsManager } from './js/managers/AnalyticsManager.js';
        
        // Global variables
        let supabase;
        let analytics;
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(
                    'https://gonsippgsrbutwanzpyo.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdvbnNpcHBnc3JidXR3YW56cHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzAyNDEsImV4cCI6MjA3MDMwNjI0MX0.2FINt1ku94IMVYzp7zKJvFSt0Z7t6gj-lCsAwcwMCXs'
                );
                
                analytics = new AnalyticsManager(supabase, { allowAnalytics: true });
                
                document.getElementById('status').innerHTML = 
                    '<div class="log success">‚úÖ Supabase & AnalyticsManager inicializov√°no</div>';
                
                log('Supabase client initialized', 'success');
                log('AnalyticsManager ready', 'success');
                
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    `<div class="log error">‚ùå Chyba: ${error.message}</div>`;
                log(`Initialization error: ${error.message}`, 'error');
            }
        }
        
        window.testSupabaseConnection = async function() {
            if (!supabase) {
                log('Supabase not initialized', 'error');
                return;
            }
            
            try {
                // Test basic connection
                const { data, error } = await supabase.from('high_scores').select('count').limit(1);
                
                if (error) {
                    log(`Supabase connection failed: ${error.message}`, 'error');
                } else {
                    log('‚úÖ Supabase connection successful', 'success');
                }
                
                // Test analytics tables (pokud u≈æ existuj√≠)
                try {
                    const { data: sessionsData, error: sessionsError } = await supabase
                        .from('game_sessions')
                        .select('count')
                        .limit(1);
                    
                    if (sessionsError) {
                        log(`Analytics tables not ready: ${sessionsError.message}`, 'warning');
                        log('üí° Run the SQL setup script in Supabase SQL Editor', 'warning');
                    } else {
                        log('‚úÖ Analytics tables accessible', 'success');
                    }
                } catch (e) {
                    log('Analytics tables not found - setup required', 'warning');
                }
                
            } catch (error) {
                log(`Connection test failed: ${error.message}`, 'error');
            }
        };
        
        window.testAnalyticsManager = function() {
            if (!analytics) {
                log('Analytics not initialized', 'error');
                return;
            }
            
            try {
                // Test various tracking methods
                analytics.trackEnemyKill('red', 5, 25);
                analytics.trackDamageDealt(50, 'green');
                analytics.trackDamageTaken(10, 'elite:purple', 8);
                
                const mockOptions = [
                    { name: 'Explosive Bullets' },
                    { name: 'Shield' },
                    { name: 'Speed Boost' }
                ];
                
                analytics.trackPowerUpOffered(mockOptions, 5, 80, 3);
                analytics.trackPowerUpSelected('Shield', mockOptions, 5, 80, 3);
                
                const stats = analytics.getSessionStats();
                log(`Analytics test successful. Session: ${stats.sessionId}`, 'success');
                log(`Events queued: ${stats.eventsQueued}, FPS: ${stats.fpsAverage.toFixed(1)}`, 'success');
                
            } catch (error) {
                log(`Analytics test failed: ${error.message}`, 'error');
            }
        };
        
        window.testMockSession = async function() {
            if (!analytics) {
                log('Analytics not initialized', 'error');
                return;
            }
            
            try {
                log('üéÆ Starting mock game session...', 'info');
                
                // Start session
                analytics.startSession('TestPlayer');
                
                // Simulate gameplay events
                setTimeout(() => {
                    analytics.trackEnemyKill('red', 1, 15);
                    analytics.trackDamageDealt(15, 'red');
                    log('Enemy killed: red', 'info');
                }, 1000);
                
                setTimeout(() => {
                    analytics.trackDamageTaken(5, 'green', 2);
                    log('Damage taken from green enemy', 'info');
                }, 2000);
                
                setTimeout(() => {
                    const mockOptions = [
                        { name: 'üî• Radioterapie' },
                        { name: '‚ö° Protonov√© dƒõlo' },
                        { name: 'üõ°Ô∏è Imunitn√≠ ≈°t√≠t' }
                    ];
                    
                    analytics.trackPowerUpOffered(mockOptions, 2, 75, 2);
                    analytics.trackPowerUpSelected('üõ°Ô∏è Imunitn√≠ ≈°t√≠t', mockOptions, 2, 75, 2);
                    log('Power-up selected: Shield', 'info');
                }, 3000);
                
                setTimeout(() => {
                    // Simulate player death
                    analytics.trackPlayerDeath(
                        { type: 'enemy:elite:purple', damage: 80 },
                        { x: 400, y: 300 },
                        { level: 3, score: 1250, enemiesKilled: 15 },
                        {
                            playerHP: 0,
                            playerMaxHP: 100,
                            activePowerUps: ['shield', 'speed'],
                            enemiesOnScreen: 4,
                            projectilesOnScreen: 2,
                            wasBossFight: false
                        }
                    );
                    log('Player death tracked', 'info');
                }, 4000);
                
                setTimeout(async () => {
                    // End session
                    const mockGameStats = {
                        score: 1250,
                        level: 3,
                        totalDamageDealt: 450,
                        totalDamageTaken: 95,
                        enemiesKilled: 15,
                        bossesDefeated: [],
                        xpCollected: 180,
                        healthPickups: 2,
                        powerUpsCollected: 3
                    };
                    
                    await analytics.endSession(mockGameStats);
                    log('üèÅ Mock session completed and uploaded!', 'success');
                    
                    // Show session summary
                    const stats = analytics.getSessionStats();
                    log(`Session duration: ${stats.duration}s, Events: ${stats.eventsQueued}`, 'success');
                    
                }, 5000);
                
            } catch (error) {
                log(`Mock session failed: ${error.message}`, 'error');
            }
        };
        
        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        };
        
        // Initialize on load
        initializeSupabase();
        
    </script>
</body>
</html>