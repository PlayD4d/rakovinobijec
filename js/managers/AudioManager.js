export class AudioManager {
    constructor(scene) {
        this.scene = scene;
        
        this.sounds = {
            levelMusic1: null,
            levelMusic2: null,
            levelMusic3: null,
            bossMusic: null,
            hit: null,
            pickup: null,
            levelup: null,
            heal: null,
            shoot: null,
            enemyDeath: null,
            bossDeath: null
        };
        
        this.currentLevelTrack = null;
        this.levelTracks = ['levelMusic1', 'levelMusic2', 'levelMusic3'];
        
        // Individu√°ln√≠ hlasitosti pro r≈Øzn√© level tracky (normalizace)
        this.trackVolumes = {
            'levelMusic1': 1.0,   // Norm√°ln√≠ hlasitost
            'levelMusic2': 0.8,   // Trochu ti≈°≈°√≠
            'levelMusic3': 1.1    // Trochu hlasitƒõj≈°√≠
        };
        
        this.currentMusic = null;
        this.musicVolume = 0.35;  // Sn√≠≈æeno o 30% z 0.5
        this.sfxVolume = 0.7;
        
        this.createSounds();
    }
    
    createSounds() {
        console.log('Creating sound objects...');
        
        // Zkontroluj ≈æe zvuky jsou naƒçten√© v cache
        const checkAndCreateSound = (key, config, logName) => {
            if (this.scene.cache.audio.has(key)) {
                try {
                    const sound = this.scene.sound.add(key, config);
                    console.log(`‚úì ${logName} sound object created`);
                    return sound;
                } catch (e) {
                    console.error(`‚úó Failed to create ${logName} sound object:`, e);
                    return null;
                }
            } else {
                console.warn(`‚úó ${logName} not found in audio cache (${key})`);
                return null;
            }
        };
        
        // Hudba - v√≠ce level track≈Ø s individu√°ln√≠mi hlasitostmi
        this.sounds.levelMusic1 = checkAndCreateSound('levelMusic1', {
            loop: true,
            volume: this.musicVolume * this.trackVolumes['levelMusic1']
        }, 'Level music 1');
        
        this.sounds.levelMusic2 = checkAndCreateSound('levelMusic2', {
            loop: true,
            volume: this.musicVolume * this.trackVolumes['levelMusic2']
        }, 'Level music 2');
        
        this.sounds.levelMusic3 = checkAndCreateSound('levelMusic3', {
            loop: true,
            volume: this.musicVolume * this.trackVolumes['levelMusic3']
        }, 'Level music 3');
        
        this.sounds.bossMusic = checkAndCreateSound('bossMusic', {
            loop: true,
            volume: this.musicVolume
        }, 'Boss music');
        
        // Zvukov√© efekty
        const soundEffects = [
            ['hit', 'Hit'],
            ['levelup', 'Level up'],
            ['pickup', 'Pickup'],
            ['powerup', 'Power up'],
            ['intro', 'Intro'],
            ['readyFight', 'Ready Fight'],
            ['bossEnter', 'Boss Enter'],
            ['gameOver', 'Game Over']
        ];
        
        soundEffects.forEach(([key, name]) => {
            this.sounds[key] = checkAndCreateSound(key, {
                volume: this.sfxVolume
            }, name);
        });
        
        // Player death sound
        this.sounds.enemyDeath = checkAndCreateSound('playerDeath', {
            volume: this.sfxVolume * 0.5
        }, 'Player death');
        
        // Shrnut√≠
        const loadedSounds = Object.entries(this.sounds).filter(([key, sound]) => sound !== null);
        console.log(`Audio setup complete: ${loadedSounds.length}/${Object.keys(this.sounds).length} sounds ready`);
    }
    
    createSyntheticSounds() {
        // Toto je zjednodu≈°en√° verze - v re√°ln√© h≈ôe bychom mƒõli skuteƒçn√© zvukov√© soubory
        // Pro MVP pou≈æijeme jednoduch√© p√≠pnut√≠
    }
    
    playLevelMusic() {
        console.log('Attempting to play level music...');
        this.stopCurrentMusic();
        
        // Vybrat n√°hodn√Ω level track
        const randomTrack = this.levelTracks[Math.floor(Math.random() * this.levelTracks.length)];
        console.log(`üéµ Selected random level track: ${randomTrack}`);
        
        this.currentLevelTrack = randomTrack;
        
        if (this.sounds[randomTrack]) {
            try {
                // Zkus pustit hudbu
                const playPromise = this.sounds[randomTrack].play();
                
                // Pokud je to Promise (modern√≠ browsery), zpracuj ho
                if (playPromise && typeof playPromise.then === 'function') {
                    playPromise.then(() => {
                        this.currentMusic = this.sounds[randomTrack];
                        console.log(`‚úì Level music started successfully: ${randomTrack}`);
                    }).catch((error) => {
                        console.warn('‚úó Level music autoplay blocked:', error.message);
                        console.log('üìå Klikni do hry pro spu≈°tƒõn√≠ hudby');
                    });
                } else {
                    // Star≈°√≠ browsery
                    this.currentMusic = this.sounds[randomTrack];
                    console.log(`‚úì Level music started (legacy): ${randomTrack}`);
                }
            } catch (e) {
                console.error('‚úó Failed to play level music:', e);
            }
        } else {
            console.warn(`‚úó Level music track not available: ${randomTrack}`);
        }
    }
    
    playBossMusic() {
        console.log('Attempting to play boss music');
        this.stopCurrentMusic();
        
        if (this.sounds.bossMusic) {
            try {
                this.sounds.bossMusic.play();
                this.currentMusic = this.sounds.bossMusic;
                console.log('Boss music started playing');
            } catch (e) {
                console.error('Failed to play boss music:', e);
            }
        } else {
            console.warn('Boss music not loaded');
        }
    }
    
    stopCurrentMusic() {
        if (this.currentMusic && this.currentMusic.isPlaying) {
            this.currentMusic.stop();
        }
    }
    
    playSound(soundName) {
        console.log(`üîä Attempting to play sound: ${soundName}`);
        
        // Pou≈æ√≠t skuteƒçn√© zvuky pokud existuj√≠
        if (this.sounds[soundName] && this.sounds[soundName] !== null) {
            try {
                console.log(`‚úì Playing real sound: ${soundName}`);
                this.sounds[soundName].play();
                return;
            } catch (e) {
                console.warn(`Failed to play ${soundName}:`, e.message);
            }
        } else {
            console.warn(`‚ö†Ô∏è Sound ${soundName} not found in this.sounds object`);
            console.log('Available sounds:', Object.keys(this.sounds));
        }
        
        // Z√°lo≈æn√≠ syntetick√© zvuky pro ty, kter√© nem√°me
        console.log(`üîä Playing synthetic sound: ${soundName}`);
        switch(soundName) {
            case 'heal':
                if (this.sounds.powerup && this.sounds.powerup !== null) {
                    try {
                        this.sounds.powerup.play();
                    } catch (e) {
                        this.playTone(600, 0.15);
                        this.playTone(800, 0.15, 75);
                    }
                } else {
                    this.playTone(600, 0.15);
                    this.playTone(800, 0.15, 75);
                }
                break;
            case 'shoot':
                this.playTone(150, 0.05);
                break;
            case 'enemyDeath':
                this.playTone(200, 0.1);
                break;
            case 'bossDeath':
                if (this.sounds.levelup && this.sounds.levelup !== null) {
                    try {
                        this.sounds.levelup.play();
                    } catch (e) {
                        // pokraƒçuj k t√≥n≈Øm
                    }
                }
                this.playTone(100, 0.3);
                this.playTone(150, 0.3, 150);
                this.playTone(200, 0.3, 300);
                break;
            default:
                // Pro nezn√°m√© zvuky pou≈æ√≠t generick√Ω t√≥n
                this.playTone(400, 0.1);
        }
    }
    
    playTone(frequency, duration, delay = 0) {
        // Pou≈æit√≠ Web Audio API pro vytvo≈ôen√≠ jednoduch√Ωch t√≥n≈Ø
        if (!window.AudioContext && !window.webkitAudioContext) {
            return;
        }
        
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();
        
        setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(this.sfxVolume * 0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }, delay);
    }
    
    stopAll() {
        this.stopCurrentMusic();
        // Zastavit v≈°echny zvuky
        Object.values(this.sounds).forEach(sound => {
            if (sound && sound.isPlaying) {
                sound.stop();
            }
        });
    }
    
    switchLevelMusic() {
        // P≈ôepnout na jin√Ω n√°hodn√Ω track (r≈Øzn√Ω od aktu√°ln√≠ho)
        const availableTracks = this.levelTracks.filter(track => track !== this.currentLevelTrack);
        if (availableTracks.length === 0) return; // Jen jeden track dostupn√Ω
        
        const newTrack = availableTracks[Math.floor(Math.random() * availableTracks.length)];
        console.log(`üéµ Switching to new level track: ${newTrack}`);
        
        this.stopCurrentMusic();
        this.currentLevelTrack = newTrack;
        
        if (this.sounds[newTrack]) {
            try {
                this.sounds[newTrack].play();
                this.currentMusic = this.sounds[newTrack];
                console.log(`‚úì Level music switched to: ${newTrack}`);
            } catch (e) {
                console.error('‚úó Failed to switch level music:', e);
            }
        }
    }
    
    setMusicVolume(volume) {
        this.musicVolume = volume;
        if (this.currentMusic && this.currentLevelTrack) {
            // Aplikuj individu√°ln√≠ hlasitost tracku
            const trackMultiplier = this.trackVolumes[this.currentLevelTrack] || 1.0;
            this.currentMusic.setVolume(volume * trackMultiplier);
        } else if (this.currentMusic) {
            // Pro jin√© hudebn√≠ tracky (boss music apod.)
            this.currentMusic.setVolume(volume);
        }
    }
    
    setSFXVolume(volume) {
        this.sfxVolume = volume;
    }
    
    // Helper metoda pro nastaven√≠ individu√°ln√≠ hlasitosti tracku
    setTrackVolume(trackName, multiplier) {
        this.trackVolumes[trackName] = multiplier;
        
        // Aktualizuj hlasitost pokud je tento track pr√°vƒõ p≈ôehr√°v√°n
        if (this.currentLevelTrack === trackName && this.currentMusic) {
            this.currentMusic.setVolume(this.musicVolume * multiplier);
        }
        
        console.log(`üîä Track ${trackName} volume set to ${multiplier}x (${(this.musicVolume * multiplier).toFixed(2)} absolute)`);
    }
    
    // Zobrazit aktu√°ln√≠ hlasitosti v≈°ech track≈Ø
    showTrackVolumes() {
        console.log('üéµ Track volumes:');
        Object.entries(this.trackVolumes).forEach(([track, multiplier]) => {
            const absolute = (this.musicVolume * multiplier).toFixed(2);
            console.log(`  ${track}: ${multiplier}x (${absolute} absolute)`);
        });
    }
}